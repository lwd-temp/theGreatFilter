// ==UserScript==
// @name         The Great Filter
// @namespace    http://tampermonkey.net/
// @homepageURL  https://github.com/uknfire/theGreatFilter
// @version      0.0.1
// @match        https://www.zhihu.com/*
// @match        https://*.twitter.com/*
// @run-at       document-start
// @grant        none
// ==/UserScript==
(()=>{var h=(...e)=>{console.log("%c TGF[search]:","color: red",...e)};function w(e){let t=e.object?.title??e.object?.question?.name;return t=t?.replaceAll("<em>","").replaceAll("</em>",""),{title:t,type:e.type,subtype:e.object?.type,hasAuthor:e.object?.author!==void 0,isAuthorAnonymous:e.object?.author?.url_token==="0",author:e.object?.author?.name,authorFollowerCount:e.object?.author?.follower_count??0,authorVoteupCount:e.object?.author?.voteup_count??0,isSearchResult:e.type==="search_result",hasVideo:e.object?.attachment?.type==="video",isVerified:e.object?.author?.badge_v2?.title==="\u5DF2\u8BA4\u8BC1\u5E10\u53F7"}}function m(e){let t=w(e);return t.isSearchResult?t.hasVideo?(h(`\u79FB\u9664\u89C6\u9891\u56DE\u7B54\uFF1A${t.title}`),!1):t.hasAuthor&&!t.isAuthorAnonymous&&t.authorFollowerCount<100?(h(`\u79FB\u9664\u4F4E\u5173\u6CE8\u7528\u6237\uFF1A${t.title} ${t.author} \u5173\u6CE8\u6570${t.authorFollowerCount}`),!1):["\u4E5D\u7AE0\u7B97\u6CD5"].includes(t.author)?(h(`\u79FB\u9664\u8425\u9500\u53F7\uFF1A${t.title} ${t.author}`),!1):["question","roundtable","special"].includes(t.subtype)?(h(`\u79FB\u9664\u975E\u56DE\u7B54\u7ED3\u679C\uFF1A${t.title} ${t.subtype}`),!1):t.title?.endsWith("!")||t.title?.endsWith("\uFF01")?(h(`\u79FB\u9664\u6807\u9898\u515A\uFF1A${t.title} ${t.subtype}`),!1):!0:(h(`\u79FB\u9664\u975E\u641C\u7D22\u7ED3\u679C\uFF1A${t.title} ${t.type}`),!1)}var d={name:"zhihuSearchFilter",isMatch:e=>e.startsWith("https://www.zhihu.com/api/v4/search_v3"),intercept:e=>{e.data=e.data.filter(m)}};var y=class{constructor(){this.filters=[];this.asyncFilters=[]}use(t){this.filters.push(t)}useAsync(t){this.asyncFilters.push(t)}buildIntercept(t){let c=this.filters.filter(r=>r.isMatch(t));if(c.length!==0)return function(r){c.forEach(s=>{try{s.intercept(r)}catch{console.error(`TGF: ${s.name} error`)}})}}buildAsyncIntercept(t){let c=this.asyncFilters.filter(r=>r.isMatch(t));if(c.length!==0)return async function(r){for(let s of c)try{await s.intercept(r)}catch{console.warn(`TGF: ${s.name} error`)}}}buildFetch(t){return async(c,r)=>{let s=await t(c,r);if(!s.ok)return s;let p=s.url,o=this.buildIntercept(p),l=this.buildAsyncIntercept(p);if(!o&&!l)return s;let u=await s.json();return o?.(u),await l?.(u),new Response(JSON.stringify(u),{headers:s.headers,status:s.status,statusText:s.statusText})}}buildXHR(t){let c=this.buildIntercept.bind(this),r=this.buildAsyncIntercept.bind(this),s=Symbol("xhrRes"),p=Symbol("xhrResText");return function(){let o=new t,l=()=>{let i=c(o.responseURL);if(i){let n=JSON.parse(o.responseText);i(n);let a=JSON.stringify(n);this.response=a,this.responseText=a}},u=async()=>{let i=r(o.responseURL);if(i){let n=JSON.parse(o.responseText);await i(n);let a=JSON.stringify(n);this.response=a,this.responseText=a}};o.onload=(...i)=>{!this.onload||(l(),u().finally(()=>{this.onload.apply(this,i)}))},o.onreadystatechange=(...i)=>{!this.onreadystatechange||(this.readyState===4?(l(),u().finally(()=>{this.onreadystatechange.apply(this,i)})):this.onreadystatechange.apply(this,i))};for(let i in o){let n=i;if(!(n==="onreadystatechange"||n==="onload"))if(typeof o[n]=="function")this[n]=o[n].bind(o);else if(n==="response"||n==="responseText"){let a=n==="response"?s:p;Object.defineProperty(this,n,{get:()=>this[a]??o[n],set:b=>this[a]=b,enumerable:!0})}else Object.defineProperty(this,n,{get:()=>o[n],set:a=>o[n]=a,enumerable:!0})}}}};var f=new y;window.location.origin==="https://www.zhihu.com"&&f.use(d);window.fetch=f.buildFetch(window.fetch);window.XMLHttpRequest=f.buildXHR(window.XMLHttpRequest);})();
