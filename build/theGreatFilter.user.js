// ==UserScript==
// @name         The Great Filter
// @author       uknfire
// @description  an ajax interceptor
// @namespace    http://tampermonkey.net/
// @homepageURL  https://github.com/uknfire/theGreatFilter
// @version      0.0.1
// @match        https://www.zhihu.com/*
// @match        https://*.twitter.com/*
// @run-at       document-start
// @grant        none
// ==/UserScript==
"use strict";(()=>{function c(...e){console.log("%c TGF[search]:","color: red",...e)}function b(e){let t=e.object?.title??e.object?.question?.name;t=t?.replaceAll("<em>","").replaceAll("</em>","");let s=e.object?.author?.name===void 0?void 0:{name:e.object.author.name,isAnonymous:e.object?.author?.url_token==="0",isVerified:e.object?.author?.badge_v2?.title==="\u5DF2\u8BA4\u8BC1\u5E10\u53F7",followerCount:e.object?.author?.follower_count??0,voteupCount:e.object?.author?.voteup_count??0};return{title:t,type:e.type,subtype:e.object?.type,isSearchResult:e.type==="search_result",hasVideo:e.object?.attachment?.type==="video",hasBaiduPan:()=>e.object?.content?.includes("https://link.zhihu.com/?target=https%3A//pan.baidu.com/s/")??!1,author:s}}function w(e){let t=b(e);return t.isSearchResult?t.hasVideo?(c(`\u79FB\u9664\u89C6\u9891\u56DE\u7B54\uFF1A${t.title}`),!1):t.author&&["\u4E5D\u7AE0\u7B97\u6CD5"].includes(t.author.name)?(c(`\u79FB\u9664\u8425\u9500\u53F7\uFF1A${t.title} ${t.author.name}`),!1):["question","roundtable","special"].includes(t.subtype)?(c(`\u79FB\u9664${t.subtype}\uFF1A${t.title}`),!1):t.title?.endsWith("!")||t.title?.endsWith("\uFF01")?(c(`\u79FB\u9664\u6807\u9898\u515A\uFF1A${t.title} ${t.subtype}`),!1):t.hasBaiduPan()?(c(`\u79FB\u9664\u767E\u5EA6\u7F51\u76D8\u94FE\u63A5\uFF1A${t.title}`),!1):!0:(c(`\u79FB\u9664${t.type}\uFF1A${t.title}`),!1)}var h={name:"zhihuSearchFilter",isMatch:e=>e.startsWith("https://www.zhihu.com/api/v4/search_v3"),intercept:e=>{e.data=e.data.filter(w)}};function p(...e){console.log("%c TGF[searchAsync]:","color: blue",...e)}async function m(e){if(e==="0")return{isAnonymous:!0,isAvailable:!1,name:"\u533F\u540D\u7528\u6237",followerCount:0,answerCount:0,articlesCount:0};let t=`https://www.zhihu.com/api/v4/members/${e}?include=answer_count%2Cfollower_count%2Carticles_count%2Cbadge[%3F(type%3Dbest_answerer)].topics`,i=await(await fetch(t)).json();return{isAnonymous:!1,isAvailable:i.error===void 0,name:i.name,answerCount:i.answer_count??0,articlesCount:i.articles_count??0,followerCount:i.follower_count??0}}async function g(e){let t=await m(e);if(!t.isAvailable||t.isAnonymous)return!0;let s=t.answerCount+t.articlesCount;return s>2e3?(p("\u592A\u9AD8\u4EA7",t.name,"\u56DE\u7B54\u548C\u6587\u7AE0\u603B\u548C",s),!1):t.followerCount/s<10?(p("\u8F6C\u5316\u7387\u592A\u4F4E",t.name,"\u56DE\u7B54\u548C\u6587\u7AE0\u603B\u548C",s,"\u5173\u6CE8\u6570",t.followerCount),!1):!0}async function F(e,t){let s=await Promise.allSettled(e.map(t));return e.filter((i,o)=>{let r=s[o];return r.status==="rejected"||r.value})}var y={name:"zhihuSearchAsyncFilter",isMatch:e=>e.startsWith("https://www.zhihu.com/api/v4/search_v3"),intercept:async e=>{let t=async s=>s.object?.author?.url_token?g(s.object.author.url_token):!0;e.data=await F(e.data,t)}};var f=class{constructor(){this.filters=[];this.asyncFilters=[]}use(t){this.filters.push(t)}useAsync(t){this.asyncFilters.push(t)}buildIntercept(t){let s=this.filters.filter(i=>i.isMatch(t));if(s.length!==0)return function(i){s.forEach(o=>{try{o.intercept(i)}catch{console.error(`TGF: ${o.name} error`)}})}}buildAsyncIntercept(t){let s=this.asyncFilters.filter(i=>i.isMatch(t));if(s.length!==0)return async function(i){for(let o of s)try{await o.intercept(i)}catch{console.warn(`TGF: ${o.name} error`)}}}buildFetch(t){return async(s,i)=>{let o=await t(s,i);if(!o.ok)return o;let r=o.url,a=this.buildIntercept(r),u=this.buildAsyncIntercept(r);if(!a&&!u)return o;let n=await o.json();return a?.(n),await u?.(n),new Response(JSON.stringify(n),{headers:o.headers,status:o.status,statusText:o.statusText})}}buildXHR(t){let s=async r=>{let a=this.buildIntercept(r.responseURL),u=this.buildAsyncIntercept(r.responseURL);if(!a&&!u)return;let n=JSON.parse(r.responseText);return a?.(n),await u?.(n),JSON.stringify(n)},i=Symbol("xhrRes"),o=Symbol("xhrResText");return function(){let r=new t,a=this;r.onreadystatechange=u=>{r.readyState===t.DONE&&r.status===200?s(r).then(n=>{n!==void 0&&(a.response=n,a.responseText=n)}).finally(()=>{a.onreadystatechange?.(u)}):a.onreadystatechange?.(u)};for(let u in r){let n=u;if(n!=="onreadystatechange"){if(n==="response"||n==="responseText"){let l=n==="response"?i:o;Object.defineProperty(a,n,{get:()=>a[l]??r[n],set:d=>a[l]=d,enumerable:!0});continue}if(typeof r[n]=="function"){a[n]=r[n].bind(r);continue}Object.defineProperty(a,n,{get:()=>r[n],set:l=>r[n]=l,enumerable:!0})}}}}};if(window.location.href.startsWith("https://www.zhihu.com/search")){let e=new f;e.use(h),e.useAsync(y),window.fetch=e.buildFetch(window.fetch),window.XMLHttpRequest=e.buildXHR(window.XMLHttpRequest)}})();
